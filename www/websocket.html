<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<link rel="stylesheet" href="../resources/lib/weui/weui.min.css">
	<link rel="stylesheet" href="../resources/lib/weui/jquery-weui.min.css">
	<link rel="stylesheet" href="../resources/css/websocket.css">
	<title>聊天室</title>
</head>
<body>
	<div class="weui-tab">
		<div class="weui-tab__bd">
			<div id="chatList" class="weui-tab__bd-item weui-tab__bd-item--active">
				<div class="weui-search-bar" id="searchBar">
					<form class="weui-search-bar__form">
						<div class="weui-search-bar__box">
						<i class="weui-icon-search"></i>
						<input type="search" class="weui-search-bar__input" id="searchInput" placeholder="搜索" required="">
						<a href="javascript:" class="weui-icon-clear" id="searchClear"></a>
						</div>
						<label class="weui-search-bar__label" id="searchText">
						<i class="weui-icon-search"></i>
						<span>搜索</span>
						</label>
					</form>
					<a href="javascript:" class="weui-search-bar__cancel-btn" id="searchCancel">取消</a>
				</div>
				<div class="weui-panel weui-panel_access">
					<!-- <div class="weui-panel__hd">我的聊天</div> -->
					<div class="weui-panel__bd myChatList">

					</div>
					<!-- <div class="weui-panel__ft">
						<a href="javascript:void(0);" class="weui-cell weui-cell_access weui-cell_link">
							<div class="weui-cell__bd">查看更多</div>
							<span class="weui-cell__ft"></span>
						</a>
					</div> -->
				</div>
			</div>
			<div id="userList" class="weui-tab__bd-item">
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="weui-cell__hd">
							<!-- <img src="../resources/images/icon.jpeg"> -->
							<i class="weui-icon-add"></i>
						</div>
						<div class="weui-cell__bd">
							<p>添加好友</p>
						</div>
						<!-- <div class="weui-cell__ft">说明文字</div> -->
					</div>

					<!--通讯录-->
				</div>
			</div>
			<div id="home" class="weui-tab__bd-item">
				<div class="weui-cells weui-cells_form">
					<div class="weui-cell">
						<div class="weui-cell__bd">
							<form action="/upload" method="POST" enctype="multipart/form-data" id="headerUpload" target="hidden-iframe">
								<div class="weui-uploader">
									<div class="weui-uploader__hd">
										<p class="weui-uploader__title">头像上传</p>
									</div>
									<div class="weui-uploader__bd">
									<ul class="weui-uploader__files" id="uploaderFiles">
										<li class="weui-uploader__file" style="background-image:url(../resources/images/icon.jpeg)"></li>
									</ul>
									<div class="weui-uploader__input-box">
										<input id="uploaderInput" class="weui-uploader__input" name="userIcon" type="file" accept="image/*" multiple="">
										<input type="hidden" name="qq" value="1231231">
									</div>
									<!-- <input type="submit" value="submit"> -->
									</div>
								</div>
							</form>
							<iframe name="hidden-iframe" style="display: none;"></iframe>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="weui-tabbar">
			<a href="#chatList" class="weui-tabbar__item weui-bar__item--on">
				<span class="weui-badge" style="position: absolute;top: -.4em;right: 1em;">8</span>
				<div class="weui-tabbar__icon">
					<img src="../resources/images/icon_nav_dialog.png" alt="">
				</div>
				<p class="weui-tabbar__label">主页</p>
			</a>
			<a href="#userList" class="weui-tabbar__item">
				<div class="weui-tabbar__icon">
					<img src="../resources/images/icon_nav_article.png" alt="">
				</div>
				<p class="weui-tabbar__label">通讯录</p>
			</a>
			<a href="#home" class="weui-tabbar__item">
				<div class="weui-tabbar__icon">
					<img src="../resources/images/icon_nav_cell.png" alt="">
				</div>
				<p class="weui-tabbar__label">我</p>
			</a>
		</div>
	</div>
	<script src="../resources/lib/jquery-2.2.4.min.js"></script>
	<script src="http://malsup.github.io/jquery.form.js"></script>
	<script src="../resources/lib/weui/jquery-weui.min.js"></script>
	<script src="../resources/lib/mustache.min.js"></script>
	<script src="../resources/base.js"></script>
	<script>
		if(location.href.indexOf('#home') != -1){
			$('.weui-tab__bd-item').removeClass('weui-tab__bd-item--active');
			$('#home').addClass('weui-tab__bd-item--active');
			$('.weui-tabbar__item').removeClass('weui-bar__item--on');
			$('a[href="#home"]').addClass('weui-bar__item--on');
		}
		$.get('/userInfo', function(json){
			if(json.success && json.userInfo){
				if(!json.userInfo.imgUrl)
					json.userInfo.imgUrl = '../resources/images/icon.jpeg';
				$('#uploaderFiles > li').css({
					backgroundImage: 'url( ' + json.userInfo.imgUrl + ' )'
				});
			}
		});
		$.get('/chatList', function(json){
			if(json.success){
				$.each(json.data,function(){
					if(!this.imgUrl){
						this.imgUrl = '../resources/images/icon.jpeg';
					}
				});
				$.getDomModule('chatList' ,function(templateHtml){
					var html = Mustache.render(templateHtml, json);
					$('.myChatList').html(html);
				});

				$.getDomModule('friendList' ,function(templateHtml){
					var html = Mustache.render(templateHtml, json);
					$('#userList > div').append(html);
				});
			}
		});
		//头像上传
		$('#uploaderInput').on('change', function(e){
			var file = e.target.files[0];
			var reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = function(event){
				$('#headerUpload').submit();
				var base64 = event.target.result;
				$('#uploaderFiles > li').css({
					backgroundImage: 'url( ' + base64 + ' )'
				});
			}
		});
	</script>
</body>
</html>
